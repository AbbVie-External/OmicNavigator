<!--
%\VignetteIndexEntry{OmicAnalyzer app}
%\VignetteEngine{knitr::knitr}
%\VignetteEncoding{UTF-8}
-->

# OmicAnalyzer app

**Date:** `r Sys.Date()`

**Package version:** `r packageVersion("OmicAnalyzer")`

* [List studies](#list-studies)
* [Results table](#results-table)
* [Enrichments table](#enrichments-table)
* [Enrichments network](#enrichments-network)
* [Features in a network node](#features-in-a-network-node)
* [Features in a network link](#features-in-a-network-link)
* [Custom plots](#custom-plots)
* [Results intersection](#results-intersection)
* [Enrichments intersection](#enrichments-intersection)
* [Results UpSet plot](#results-upset-plot)
* [Enrichments UpSet plot](#enrichments-upset-plot)
* [UpSet columns](#upset-columns)
* [metaFeatures table](#metafeatures-table)
* [Barcode](#barcode)

These functions are intended to support the web application via OpenCPU calls.

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  comment = "",
  message = FALSE
)
```

```{r packages}
library(jsonlite)
library(OmicAnalyzer)
```

```{r test-data, include=FALSE}
tmplib <- tempfile()
dir.create(tmplib)
.libPaths(c(tmplib, .libPaths()))
abc <- OmicAnalyzer:::testStudy(name = "ABC")
plots <- OmicAnalyzer:::testPlots()
abc <- addPlots(abc, plots)
plotsAll <- unlist(lapply(plots, names), use.names = FALSE)
OmicAnalyzer::installStudy(abc)
OmicAnalyzer::installStudy(OmicAnalyzer:::testStudy(name = "XYZ"))
rm(plots, list = plotsAll)
```

## List studies

List all the available studies along with their models, tests, annotations, and
plots.

```{r list-studies, eval=FALSE}
studies <- listStudies()
```

```{r list-studies-hidden, echo=FALSE}
studies <- listStudies(libraries = tmplib)
```

```{r list-studies-json}
toJSON(studies, auto_unbox = TRUE, pretty = TRUE)
```

## Results table

For a given study, model, and test, return a table that contains the feature
metadata and the inference results.

The column names are chosen by the user. The first column is the unique
featureID used in the study. It should be passed to
[`plotStudy()`](#custom-plots) to create any custom plots.

```{r results-table}
resultsTable <- getResultsTable("ABC", "model_01", "test_01")
toJSON(resultsTable[1:2, ], pretty = TRUE)
```

## Enrichments table

For a given study, model, and annotation, return a table that contains the
enrichment results. The default is to return the nominal statistical values.

```{r enrichments-table}
enrichmentsTable <- getEnrichmentsTable("ABC", "model_01", "annotation_01")
toJSON(enrichmentsTable[1:2, ], pretty = TRUE)
```

Set `type = "adjusted"` to obtain statistical values adjusted for multiple
testing.

```{r enrichments-table-adjusted}
enrichmentsTable <- getEnrichmentsTable("ABC", "model_01", "annotation_01", type = "adjusted")
toJSON(enrichmentsTable[1:2, ], pretty = TRUE)
```

The first two columns are always `termID` and `description`. The remaining
columns are the names of the tests defined by the user. The column `termID` is
used to create the [barcode plot](#barcode).

## Enrichments network

For a given study, model, and annotation, return the nodes and links of the
network graph.

```{r enrichments-network}
enrichmentsNetwork <- getEnrichmentsNetwork("ABC", "model_01", "annotation_01")
toJSON(enrichmentsNetwork, auto_unbox = TRUE, pretty = TRUE)
```

## Features in a network node

For a given study, annotation, and term, return the features in that term.

```{r getNodeFeatures}
nodeFeatures <- getNodeFeatures("ABC", "annotation_01", "term_01")
toJSON(nodeFeatures, pretty = TRUE)
```

## Features in a network link

For a given study, annotation, and two terms, return the features shared by the
terms.

```{r getLinkFeatures}
linkFeatures <- getLinkFeatures("ABC", "annotation_01", "term_01", "term_03")
toJSON(linkFeatures, pretty = TRUE)
```

## Custom plots

Display the custom plots provided by the user with `plotStudy()`. Provided a
study, model, feature, and plot, `plotStudy()` generates the custom plot.

The featureID is obtained from the first column returned by
[`getResultsTable()`](#results-table). The remaining arguments are obtained from
the output from [`listStudies()`](#list-studies).

```{r plotStudy-plotBase}
plotStudy(
  study = "ABC",
  modelID = "model_01",
  featureID = "feature_0001",
  plotID = "plotBase"
)
```

```{r plotStudy-plotGg}
plotStudy(
  study = "ABC",
  modelID = "model_03",
  featureID = "feature_0001",
  plotID = "plotGg"
)
```

## Results intersection

For a given study and model, filter the inference results table by the values of
specific columns in any test of that model. Use
[`getUpsetCols()`](#upset-columns) to obtain the common columns across all tests
of the model.

```{r getResultsIntersection}
resultsIntersection <- getResultsIntersection(
  study = "ABC",
  modelID = "model_01",
  anchor = "test_01",
  mustTests = c("test_01", "test_02"),
  notTests = c(),
  sigValue = .5,
  operator = "<",
  column = "p_val"
)
toJSON(resultsIntersection[1:2, ], pretty = TRUE)
```

## Enrichments intersection

For a given study and model, filter the enrichments table (or network) by the
results of the enrichment tests.

```{r getEnrichmentsIntersection}
enrichmentsIntersection <- getEnrichmentsIntersection(
  study = "ABC",
  modelID = "model_01",
  annotationID = "annotation_01",
  mustTests = c("test_01", "test_02"),
  notTests = c(),
  sigValue = .5,
  operator = "<",
  type = "nominal"
)
toJSON(enrichmentsIntersection[1:2, ], pretty = TRUE)
```

## Results UpSet plot

```{r getResultsUpset}
resultsUpset <- getResultsUpset(
  study = "ABC",
  modelID = "model_01",
  sigValue = .5,
  operator = "<",
  column = "p_val"
)
```

## Enrichments UpSet plot

```{r getEnrichmentsUpset}
enrichmentsUpset <- getEnrichmentsUpset(
  study = "ABC",
  modelID = "model_01",
  annotationID = "annotation_02",
  sigValue = .05,
  operator = "<",
  type = "nominal"
)
```

## UpSet columns

Given a study and model, `getUpsetCols()` returns the columns common across all
the available tests, and thus are available for filtering with
[`getResultsIntersection()`](#results-intersection).

```{r getUpsetCols}
upsetCols <- getUpsetCols(
  study = "ABC",
  modelID = "model_01"
)
toJSON(upsetCols, auto_unbox = TRUE, pretty = TRUE)
```

## metaFeatures table

For a given study, model, and featureID, return a table that contains the metaFeatures
associated with that featureID.

```{r metaFeatures-table}
metaFeaturesTable <- getMetaFeaturesTable("ABC", "model_01", "feature_0001")
toJSON(metaFeaturesTable[1:2, ], pretty = TRUE)
```

## Barcode

Given a study, model, test, annotation, and term, `getBarcodeData()` returns
the data required to create the barcode and violin plots.

The `termID` is obtained from [`getEnrichmentsTable()`](#enrichments-table). The
remaining arguments are obtained from the output from
[`listStudies()`](#list-studies).

The elements of the `data` array are sorted by the value of `statistic` (highest
to lowest).

```{r getBarcodeData}
barcodeData <- getBarcodeData(
  study = "ABC",
  modelID = "model_01",
  testID = "test_01",
  annotationID = "annotation_02",
  termID = "term_05"
)
toJSON(barcodeData, auto_unbox = TRUE, pretty = TRUE)
```
